<div class="container py-4">

  <!-- Back Button -->
  <%= link_to products_path, class: "btn btn-outline-secondary mb-4" do %>
    <i class="bi bi-arrow-left"></i> Back to Products
  <% end %>

  <div class="row g-4">

    <!-- Images Section -->
    <div class="col-lg-6">
      <!-- Main Image -->
      <div class="card mb-3">
        <div id="mainImage" class="position-relative" style="height: 400px; background: #f8f9fa;">
          <% if @product.images.attached? && @product.images.first.present? %>
            <%= image_tag @product.images.first,
                          id: "currentImage",
                          style: "width: 100%; height: 100%; object-fit: contain;",
                          alt: @product.name %>
          <% else %>
            <div class="d-flex align-items-center justify-content-center h-100 text-muted" style="font-size: 5rem;">
              ðŸ“¦
            </div>
          <% end %>
        </div>
      </div>

      <!-- Thumbnail Gallery -->
      <% if @product.images.attached? && @product.images.count > 1 %>
        <div class="row g-2">
          <% @product.images.each_with_index do |image, index| %>
            <div class="col-3">
              <div class="thumbnail-item border rounded overflow-hidden <%= 'border-primary border-3' if index == 0 %>"
                   style="cursor: pointer; height: 80px;"
                   onclick="changeImage('<%= url_for(image) %>', this)">
                <%= image_tag image, style: "width: 100%; height: 100%; object-fit: cover;" %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Product Details -->
    <div class="col-lg-6">
      <!-- Badges -->
      <% if @product.on_sale || @product.new_arrival || @product.created_at > 3.days.ago %>
        <div class="mb-3">
          <% if @product.on_sale %>
            <span class="badge bg-danger me-2">ON SALE</span>
          <% end %>
          <% if @product.new_arrival || @product.created_at > 3.days.ago %>
            <span class="badge bg-success">NEW</span>
          <% end %>
        </div>
      <% end %>

      <!-- Product Name -->
      <h1 class="display-6 fw-bold mb-4">
        <%= @product.name %>
      </h1>

      <!-- Price -->
      <div class="mb-4">
        <div class="price-display">
          â‚¦<%= number_with_delimiter(@product.price.to_i) %>
        </div>
      </div>

      <!-- Stock Status -->
      <div class="mb-4">
        <% if @product.stock_quantity > 10 %>
          <div class="stock-status in-stock">
            <i class="bi bi-check-circle-fill"></i>
            <span>In Stock (<%= @product.stock_quantity %> available)</span>
          </div>
        <% elsif @product.stock_quantity > 0 %>
          <div class="stock-status low-stock">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span>Low Stock (Only <%= @product.stock_quantity %> left)</span>
          </div>
        <% else %>
          <div class="stock-status out-of-stock">
            <i class="bi bi-x-circle-fill"></i>
            <span>Out of Stock</span>
          </div>
        <% end %>
      </div>

      <!-- Categories -->
      <% if @product.categories.any? %>
        <div class="mb-4">
          <div class="small text-muted mb-2">Categories:</div>
          <div class="d-flex flex-wrap gap-2">
            <% @product.categories.each do |category| %>
              <%= link_to category.name,
                  category_products_path(category_id: category.id),
                  class: "badge bg-secondary text-decoration-none" %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Add to Cart Form -->
      <div class="card bg-light mb-4">
        <div class="card-body">
          <%= form_with url: add_cart_path, method: :post, local: true do %>
            <%= hidden_field_tag :product_id, @product.id %>

            <div class="mb-3">
              <label class="form-label fw-bold">Quantity:</label>
              <div class="d-flex align-items-center gap-2">
                <button type="button"
                        onclick="document.getElementById('quantity').stepDown();"
                        class="btn btn-outline-secondary">
                  <i class="bi bi-dash"></i>
                </button>

                <%= number_field_tag :quantity, 1,
                    min: 1,
                    max: @product.stock_quantity,
                    id: 'quantity',
                    class: "form-control text-center",
                    style: "width: 80px;" %>

                <button type="button"
                        onclick="document.getElementById('quantity').stepUp();"
                        class="btn btn-outline-secondary">
                  <i class="bi bi-plus"></i>
                </button>

                <span class="text-muted small">
                  Max: <%= @product.stock_quantity %>
                </span>
              </div>
            </div>

            <% if @product.stock_quantity > 0 %>
              <%= submit_tag "Add to Cart", class: "btn btn-primary w-100 btn-lg" %>
            <% else %>
              <button disabled class="btn btn-secondary w-100 btn-lg">
                Out of Stock
              </button>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Product Details Card -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">Product Details</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm mb-0">
            <tbody>
              <tr>
                <td class="text-muted">Product ID:</td>
                <td class="fw-semibold">#<%= @product.id %></td>
              </tr>
              <tr>
                <td class="text-muted">Date Added:</td>
                <td class="fw-semibold"><%= @product.created_at.strftime("%B %d, %Y") %></td>
              </tr>
              <tr>
                <td class="text-muted">Availability:</td>
                <td class="fw-semibold">
                  <%= @product.stock_quantity > 0 ? "In Stock" : "Out of Stock" %>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Description -->
  <div class="card mt-4">
    <div class="card-header bg-white">
      <h4 class="mb-0">Description</h4>
    </div>
    <div class="card-body">
      <p class="mb-0" style="white-space: pre-line;">
        <%= @product.description %>
      </p>
    </div>
  </div>

  <!-- Related Products -->
  <% if @product.categories.any? %>
    <% related_products = @product.categories.first.products.where.not(id: @product.id).limit(4) %>
    <% if related_products.any? %>
      <div class="mt-5">
        <h3 class="mb-4">Related Products</h3>
        <div class="row g-4">
          <% related_products.each do |product| %>
            <div class="col-sm-6 col-md-3">
              <%= link_to product_path(product), class: "text-decoration-none product-card" do %>
                <div class="card h-100">
                  <div class="bg-light" style="height: 180px; overflow: hidden">
                    <% if product.images.attached? && product.images.first.present? %>
                      <%= image_tag product.images.first,
                                    class: "card-img-top product-image",
                                    style: "width: 100%; height: 100%; object-fit: contain; padding: 1rem;",
                                    alt: product.name %>
                    <% else %>
                      <div class="d-flex align-items-center justify-content-center h-100 text-muted" style="font-size: 3rem;">
                        ðŸ“¦
                      </div>
                    <% end %>
                  </div>

                  <div class="card-body">
                    <h6 class="card-title line-clamp-2 mb-2">
                      <%= product.name %>
                    </h6>
                    <div class="h5 text-primary mb-0">
                      â‚¦<%= number_with_delimiter(product.price.to_i) %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- JavaScript for Image Gallery -->
<script>
  function changeImage(imageUrl, element) {
    // Update main image
    document.getElementById('currentImage').src = imageUrl;

    // Update thumbnail borders
    document.querySelectorAll('.thumbnail-item').forEach(item => {
      item.classList.remove('border-primary', 'border-3');
      item.classList.add('border');
    });
    element.classList.add('border-primary', 'border-3');
  }
</script>