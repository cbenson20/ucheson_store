<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Back Button -->
  <%= link_to products_path, class: "inline-flex items-center text-gray-600 hover:text-primary-600 mb-6 transition-colors" do %>
    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
    Back to Products
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">

    <!-- Images Section -->
    <div>
      <!-- Main Image -->
      <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-4">
        <div id="mainImage" class="h-96 bg-gray-100 flex items-center justify-center">
          <% if @product.images.attached? && @product.images.first.present? %>
            <%= image_tag @product.images.first,
                          id: "currentImage",
                          class: "w-full h-full object-contain",
                          alt: @product.name %>
          <% else %>
            <div class="text-gray-400 text-6xl">ðŸ“¦</div>
          <% end %>
        </div>
      </div>

      <!-- Thumbnail Gallery -->
      <% if @product.images.attached? && @product.images.count > 1 %>
        <div class="grid grid-cols-4 gap-2">
          <% @product.images.each_with_index do |image, index| %>
            <div class="cursor-pointer border-2 rounded-lg overflow-hidden hover:border-primary-600 transition-colors thumbnail-item <%= 'border-primary-600' if index == 0 %>"
                 onclick="changeImage('<%= url_for(image) %>', this)">
              <%= image_tag image, class: "w-full h-20 object-cover" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Product Details -->
    <div>
      <!-- Badges -->
      <div class="flex gap-2 mb-3">
        <% if @product.on_sale %>
          <span class="px-3 py-1 bg-red-600 text-white text-sm font-bold rounded">ON SALE</span>
        <% end %>
        <% if @product.new_arrival || @product.created_at > 3.days.ago %>
          <span class="px-3 py-1 bg-green-600 text-white text-sm font-bold rounded">NEW</span>
        <% end %>
      </div>

      <!-- Product Name -->
      <h1 class="text-3xl font-bold text-gray-900 mb-4">
        <%= @product.name %>
      </h1>

      <!-- Price -->
      <div class="mb-6">
        <div class="text-4xl font-bold text-primary-600">
          â‚¦<%= number_with_delimiter(@product.price.to_i) %>
        </div>
      </div>

      <!-- Stock Status -->
      <div class="mb-6">
        <% if @product.stock_quantity > 10 %>
          <div class="flex items-center text-green-600">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="font-semibold">In Stock (<%= @product.stock_quantity %> available)</span>
          </div>
        <% elsif @product.stock_quantity > 0 %>
          <div class="flex items-center text-yellow-600">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <span class="font-semibold">Low Stock (Only <%= @product.stock_quantity %> left)</span>
          </div>
        <% else %>
          <div class="flex items-center text-red-600">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <span class="font-semibold">Out of Stock</span>
          </div>
        <% end %>
      </div>

      <!-- Categories -->
      <% if @product.categories.any? %>
        <div class="mb-6">
          <div class="text-sm text-gray-600 mb-2">Categories:</div>
          <div class="flex flex-wrap gap-2">
            <% @product.categories.each do |category| %>
              <%= link_to category.name,
                  category_products_path(category_id: category.id),
                  class: "px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors" %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Add to Cart Form -->
      <div class="bg-gray-50 rounded-lg p-6 mb-6">
        <%= form_with url: add_cart_path, method: :post, local: true do %>
          <%= hidden_field_tag :product_id, @product.id %>

          <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity:</label>
            <div class="flex items-center gap-3">
              <button type="button"
                      onclick="document.getElementById('quantity').stepDown();"
                      class="w-10 h-10 bg-gray-200 rounded-lg font-bold text-gray-700 hover:bg-gray-300 transition-colors">
                âˆ’
              </button>

              <%= number_field_tag :quantity, 1,
                  min: 1,
                  max: @product.stock_quantity,
                  id: 'quantity',
                  class: "w-20 text-center border-2 border-gray-300 rounded-lg py-2 font-semibold" %>

              <button type="button"
                      onclick="document.getElementById('quantity').stepUp();"
                      class="w-10 h-10 bg-gray-200 rounded-lg font-bold text-gray-700 hover:bg-gray-300 transition-colors">
                +
              </button>

              <span class="text-sm text-gray-600">
                Max: <%= @product.stock_quantity %>
              </span>
            </div>
          </div>

          <% if @product.stock_quantity > 0 %>
            <%= submit_tag "Add to Cart", class: "w-full btn-primary text-lg" %>
          <% else %>
            <button disabled class="w-full px-6 py-3 bg-gray-300 text-gray-600 font-semibold rounded-lg cursor-not-allowed">
              Out of Stock
            </button>
          <% end %>
        <% end %>
      </div>

      <!-- Product Details -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-3">Product Details</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between py-2 border-b border-gray-100">
            <span class="text-gray-600">Product ID:</span>
            <span class="font-semibold">#<%= @product.id %></span>
          </div>
          <div class="flex justify-between py-2 border-b border-gray-100">
            <span class="text-gray-600">Date Added:</span>
            <span class="font-semibold"><%= @product.created_at.strftime("%B %d, %Y") %></span>
          </div>
          <div class="flex justify-between py-2">
            <span class="text-gray-600">Availability:</span>
            <span class="font-semibold">
              <%= @product.stock_quantity > 0 ? "In Stock" : "Out of Stock" %>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Description -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">Description</h2>
    <div class="text-gray-700 leading-relaxed whitespace-pre-line">
      <%= @product.description %>
    </div>
  </div>

  <!-- Related Products -->
  <% if @product.categories.any? %>
    <% related_products = @product.categories.first.products.where.not(id: @product.id).limit(4) %>
    <% if related_products.any? %>
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Related Products</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <% related_products.each do |product| %>
            <%= link_to product_path(product), class: "product-card group" do %>
              <div class="relative h-48 bg-gray-100 overflow-hidden">
                <% if product.images.attached? && product.images.first.present? %>
                  <%= image_tag product.images.first,
                                class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-300",
                                alt: product.name %>
                <% else %>
                  <div class="w-full h-full flex items-center justify-center text-gray-400 text-4xl">
                    ðŸ“¦
                  </div>
                <% end %>
              </div>

              <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2">
                  <%= product.name %>
                </h3>
                <div class="text-xl font-bold text-primary-600">
                  â‚¦<%= number_with_delimiter(product.price.to_i) %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<!-- JavaScript for Image Gallery -->
<script>
  function changeImage(imageUrl, element) {
    // Update main image
    document.getElementById('currentImage').src = imageUrl;

    // Update thumbnail borders
    document.querySelectorAll('.thumbnail-item').forEach(item => {
      item.classList.remove('border-primary-600');
      item.classList.add('border-gray-200');
    });
    element.classList.add('border-primary-600');
    element.classList.remove('border-gray-200');
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>