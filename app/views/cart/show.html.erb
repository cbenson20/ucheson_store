<div class="container py-4">
  <h1 class="display-5 fw-bold text-center mb-4">
    ðŸ›’ Your Shopping Cart
  </h1>

  <% if @cart_items.any? %>
    <div class="row g-4">

      <!-- Cart Items -->
      <div class="col-lg-8">
        <% @cart_items.each do |item| %>
          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-3 align-items-center">

                <!-- Product Image -->
                <div class="col-md-2">
                  <div style="width: 100px; height: 100px;" class="bg-light rounded d-flex align-items-center justify-content-center overflow-hidden">
                    <% if item[:product].images.attached? && item[:product].images.first.present? %>
                      <%= link_to product_path(item[:product]) do %>
                        <%= image_tag item[:product].images.first,
                                      style: "width: 100%; height: 100%; object-fit: cover;",
                                      alt: item[:product].name %>
                      <% end %>
                    <% else %>
                      <span style="font-size: 2rem;">ðŸ“¦</span>
                    <% end %>
                  </div>
                </div>

                <!-- Product Details -->
                <div class="col-md-4">
                  <h5 class="card-title mb-2">
                    <%= link_to item[:product].name, product_path(item[:product]), class: "text-decoration-none text-dark" %>
                  </h5>
                  <p class="card-text text-muted small mb-0">
                    <%= truncate(item[:product].description, length: 100) %>
                  </p>
                </div>

                <!-- Price -->
                <div class="col-md-2 text-center">
                  <div class="text-muted small">Price</div>
                  <div class="fw-bold fs-5 text-primary">
                    â‚¦<%= number_with_delimiter(item[:product].price.to_i) %>
                  </div>
                </div>

                <!-- Quantity -->
                <div class="col-md-2">
                  <div class="text-muted small text-center mb-2">Quantity</div>
                  <%= form_with url: update_quantity_cart_path(id: item[:product].id), method: :patch, local: true do %>
                    <div class="input-group input-group-sm">
                      <button type="button"
                              onclick="this.nextElementSibling.stepDown(); this.form.submit();"
                              class="btn btn-outline-secondary">
                        âˆ’
                      </button>

                      <%= number_field_tag :quantity, item[:quantity],
                          min: 0,
                          max: item[:product].stock_quantity,
                          class: "form-control text-center",
                          style: "width: 60px;",
                          onchange: "this.form.submit();" %>

                      <button type="button"
                              onclick="this.previousElementSibling.stepUp(); this.form.submit();"
                              class="btn btn-outline-secondary">
                        +
                      </button>
                    </div>
                  <% end %>
                  <div class="text-muted small text-center mt-1">
                    Max: <%= item[:product].stock_quantity %>
                  </div>
                </div>

                <!-- Line Total & Remove -->
                <div class="col-md-2 text-end">
                  <div class="text-muted small">Total</div>
                  <div class="fw-bold fs-5 text-success mb-2">
                    â‚¦<%= number_with_delimiter(item[:line_total].to_i) %>
                  </div>
                  <%= link_to remove_cart_path(id: item[:product].id),
                              method: :delete,
                              data: { turbo_method: :delete, turbo_confirm: "Remove #{item[:product].name} from cart?" },
                              class: "btn btn-sm btn-danger" do %>
                    <i class="bi bi-trash"></i> Remove
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Clear Cart Button -->
        <div class="text-center mt-3">
          <%= link_to clear_cart_path,
                      method: :delete,
                      data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to clear your entire cart?" },
                      class: "btn btn-outline-danger" do %>
            <i class="bi bi-trash"></i> Clear Entire Cart
          <% end %>
        </div>
      </div>

      <!-- Cart Summary -->
      <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Cart Summary</h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Items in cart:</span>
              <span class="fw-bold"><%= @cart_items.sum { |item| item[:quantity] } %></span>
            </div>

            <div class="d-flex justify-content-between pb-3 mb-3 border-bottom">
              <span class="text-muted">Subtotal:</span>
              <span class="fs-4 fw-bold text-primary">
                â‚¦<%= number_with_delimiter(@cart_total.to_i) %>
              </span>
            </div>

            <div class="alert alert-warning py-2">
              <small>
                <i class="bi bi-info-circle"></i>
                Taxes and shipping will be calculated at checkout based on your province.
              </small>
            </div>

            <%= link_to new_order_path, class: "btn btn-success w-100 mb-2" do %>
              <i class="bi bi-cart-check"></i> Proceed to Checkout
            <% end %>

            <%= link_to products_path, class: "btn btn-outline-secondary w-100" do %>
              <i class="bi bi-arrow-left"></i> Continue Shopping
            <% end %>
          </div>
        </div>
      </div>
    </div>

  <% else %>
    <!-- Empty Cart State -->
    <div class="text-center py-5">
      <div style="font-size: 5rem;">ðŸ›’</div>
      <h2 class="h3 text-muted mb-3">Your cart is empty</h2>
      <p class="text-muted mb-4">
        Looks like you haven't added any items to your cart yet.
      </p>
      <%= link_to products_path, class: "btn btn-primary btn-lg" do %>
        <i class="bi bi-shop"></i> Start Shopping
      <% end %>
    </div>
  <% end %>
</div>