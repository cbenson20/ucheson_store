<div class="container py-4">
  <h1 class="display-5 fw-bold text-center mb-4">
    üõçÔ∏è Checkout
  </h1>

  <div class="row g-4">

    <!-- Checkout Form -->
    <div class="col-lg-7">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üì¶ Shipping Information</h5>
        </div>
        <div class="card-body">

          <% if user_signed_in? %>
            <div class="alert alert-success">
              <i class="bi bi-person-check"></i>
              <strong>Hi <%= current_user.first_name %>!</strong> Your information has been pre-filled.
            </div>
          <% end %>

          <%= form_with url: orders_path, method: :post, local: true do %>

            <!-- Customer Information -->
            <h6 class="fw-bold mb-3">Contact Information</h6>

            <div class="mb-3">
              <label class="form-label fw-semibold">
                Email Address <span class="text-danger">*</span>
              </label>
              <%= email_field_tag :email, user_signed_in? ? @user.email : nil,
                  required: true,
                  readonly: user_signed_in?,
                  placeholder: "your.email@example.com",
                  class: "form-control #{user_signed_in? ? 'bg-light' : ''}" %>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-semibold">
                  First Name <span class="text-danger">*</span>
                </label>
                <%= text_field_tag :first_name, user_signed_in? ? @user.first_name : nil,
                    required: true,
                    placeholder: "John",
                    class: "form-control" %>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">
                  Last Name <span class="text-danger">*</span>
                </label>
                <%= text_field_tag :last_name, user_signed_in? ? @user.last_name : nil,
                    required: true,
                    placeholder: "Doe",
                    class: "form-control" %>
              </div>
            </div>

            <!-- Shipping Address -->
            <h6 class="fw-bold mb-3 pt-3 border-top">Shipping Address</h6>

            <div class="mb-3">
              <label class="form-label fw-semibold">
                Street Address <span class="text-danger">*</span>
              </label>
              <%= text_field_tag :street_address, @address&.street_address,
                  required: true,
                  placeholder: "123 Main Street, Apt 4B",
                  class: "form-control" %>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-8">
                <label class="form-label fw-semibold">
                  City <span class="text-danger">*</span>
                </label>
                <%= text_field_tag :city, @address&.city,
                    required: true,
                    placeholder: "Toronto",
                    class: "form-control" %>
              </div>

              <div class="col-md-4">
                <label class="form-label fw-semibold">
                  Postal Code <span class="text-danger">*</span>
                </label>
                <%= text_field_tag :postal_code, @address&.postal_code,
                    required: true,
                    placeholder: "M5V 3A8",
                    class: "form-control" %>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label fw-semibold">
                Province/Territory <span class="text-danger">*</span>
              </label>
              <%= select_tag :province_id,
                  options_from_collection_for_select(@provinces, :id, :name, @address&.province_id),
                  required: true,
                  id: 'province_select',
                  class: "form-select",
                  onchange: "updateTaxPreview()" %>
              <div id="tax_preview" class="alert alert-info mt-2 py-2">
                <small><strong>Tax Information:</strong> Select a province to see applicable taxes</small>
              </div>
            </div>

            <!-- Submit Button -->
            <%= submit_tag "Place Order", class: "btn btn-success w-100 btn-lg" %>

            <%= link_to cart_path, class: "btn btn-outline-secondary w-100 mt-2" do %>
              <i class="bi bi-arrow-left"></i> Back to Cart
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="col-lg-5">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">üìã Order Summary</h5>
        </div>
        <div class="card-body">

          <!-- Cart Items -->
          <div class="mb-3" style="max-height: 300px; overflow-y: auto;">
            <% @cart_items.each do |item| %>
              <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                <div class="flex-grow-1">
                  <div class="fw-bold text-dark small">
                    <%= item[:product].name %>
                  </div>
                  <div class="text-muted small">
                    <%= item[:quantity] %> √ó ‚Ç¶<%= number_with_delimiter(item[:product].price.to_i) %>
                  </div>
                </div>
                <div class="fw-bold text-primary">
                  ‚Ç¶<%= number_with_delimiter(item[:line_total].to_i) %>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Totals -->
          <div class="border-top pt-3">
            <div class="d-flex justify-content-between text-muted mb-2">
              <span>Subtotal:</span>
              <span id="subtotal">‚Ç¶<%= number_with_delimiter(@cart_total.to_i) %></span>
            </div>

            <div id="tax_breakdown" class="text-muted small mb-2" style="display: none;"></div>

            <div class="d-flex justify-content-between text-muted mb-3">
              <span>Tax:</span>
              <span id="tax_amount">‚Ç¶0</span>
            </div>

            <div class="d-flex justify-content-between fs-4 fw-bold text-success pt-3 border-top">
              <span>Total:</span>
              <span id="total">‚Ç¶<%= number_with_delimiter(@cart_total.to_i) %></span>
            </div>
          </div>

          <div class="alert alert-warning mt-3 py-2">
            <small>
              <i class="bi bi-info-circle"></i>
              Tax will be calculated based on your selected province.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for Tax Calculation Preview -->
<script>
  // Province tax data
  const provinces = {
    <% @provinces.each do |province| %>
      <%= province.id %>: {
        name: '<%= province.name %>',
        gst: <%= province.gst_rate || 0 %>,
        pst: <%= province.pst_rate || 0 %>,
        hst: <%= province.hst_rate || 0 %>,
        total: <%= province.total_tax_rate %>
      },
    <% end %>
  };

  const subtotal = <%= @cart_total %>;

  function updateTaxPreview() {
    const provinceId = document.getElementById('province_select').value;
    const province = provinces[provinceId];

    if (province) {
      let taxBreakdown = '';

      if (province.hst > 0) {
        taxBreakdown = `HST: ${(province.hst * 100).toFixed(2)}%`;
      } else {
        const parts = [];
        if (province.gst > 0) parts.push(`GST: ${(province.gst * 100).toFixed(2)}%`);
        if (province.pst > 0) parts.push(`PST: ${(province.pst * 100).toFixed(2)}%`);
        taxBreakdown = parts.join(' + ');
      }

      document.getElementById('tax_preview').innerHTML =
        `<small><strong>Tax Information for ${province.name}:</strong><br>${taxBreakdown} = ${(province.total * 100).toFixed(2)}% total</small>`;

      // Update order summary
      const taxAmount = subtotal * province.total;
      const total = subtotal + taxAmount;

      document.getElementById('tax_amount').textContent =
        '‚Ç¶' + Math.round(taxAmount).toLocaleString();
      document.getElementById('total').textContent =
        '‚Ç¶' + Math.round(total).toLocaleString();

      // Show tax breakdown
      let breakdownHTML = '';
      if (province.gst > 0) {
        breakdownHTML += `<div class="d-flex justify-content-between"><span>GST (${(province.gst * 100).toFixed(2)}%):</span><span>‚Ç¶${Math.round(subtotal * province.gst).toLocaleString()}</span></div>`;
      }
      if (province.pst > 0) {
        breakdownHTML += `<div class="d-flex justify-content-between"><span>PST (${(province.pst * 100).toFixed(2)}%):</span><span>‚Ç¶${Math.round(subtotal * province.pst).toLocaleString()}</span></div>`;
      }
      if (province.hst > 0) {
        breakdownHTML += `<div class="d-flex justify-content-between"><span>HST (${(province.hst * 100).toFixed(2)}%):</span><span>‚Ç¶${Math.round(subtotal * province.hst).toLocaleString()}</span></div>`;
      }

      if (breakdownHTML) {
        document.getElementById('tax_breakdown').innerHTML = breakdownHTML;
        document.getElementById('tax_breakdown').style.display = 'block';
      }
    }
  }

  // Trigger on page load if a province is pre-selected
  document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('province_select').value) {
      updateTaxPreview();
    }
  });
</script>