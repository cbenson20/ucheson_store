<h1 style="font-size: 2.5rem; color: #1e3c72; margin-bottom: 2rem; text-align: center;">
  üõçÔ∏è Checkout
</h1>

<div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; align-items: start;">

  <!-- Checkout Form -->
  <div style="background: white; border-radius: 10px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h2 style="font-size: 1.8rem; color: #2c3e50; margin-bottom: 1.5rem; border-bottom: 2px solid #ecf0f1; padding-bottom: 1rem;">
      üì¶ Shipping Information
    </h2>

    <%= form_with url: orders_path, method: :post, local: true do %>
      <% if user_signed_in? %>
        <div style="background: #e8f5e9; border-left: 4px solid #27ae60; padding: 1rem; margin-bottom: 1.5rem; border-radius: 3px;">
          <strong>üëã Hi <%= current_user.first_name %>!</strong> Your information has been pre-filled. You can edit it if needed.
        </div>
      <% end %>
      <!-- Customer Information -->
      <div style="margin-bottom: 2rem;">
        <h3 style="font-size: 1.2rem; color: #34495e; margin-bottom: 1rem;">Contact Information</h3>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">
            Email Address <span style="color: #e74c3c;">*</span>
          </label>
          <%= email_field_tag :email, user_signed_in? ? @user.email : nil,
              required: true,
              placeholder: "your.email@example.com",
              readonly: user_signed_in?,
              style: "width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem; #{user_signed_in? ? 'background: #f5f5f5;' : ''}" %>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">
              First Name <span style="color: #e74c3c;">*</span>
            </label>
         <%= text_field_tag :first_name, user_signed_in? ? @user.first_name : nil,                required: true,
                placeholder: "constance",
                style: "width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem;" %>
          </div>

          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">
              Last Name <span style="color: #e74c3c;">*</span>
            </label>
             <%= text_field_tag :last_name, user_signed_in? ? @user.last_name : nil,                required: true,
                placeholder: "Doe",
                style: "width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem;" %>
          </div>
        </div>
      </div>

      <!-- Shipping Address -->
      <div style="margin-bottom: 2rem;">
        <h3 style="font-size: 1.2rem; color: #34495e; margin-bottom: 1rem;">Shipping Address</h3>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">
            Street Address <span style="color: #e74c3c;">*</span>
          </label>
          <%= text_field_tag :street_address, @address&.street_address,
              required: true,
              placeholder: "123 Main Street, Apt 4B",
              style: "width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem;" %>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">
              City <span style="color: #e74c3c;">*</span>
            </label>
            <%= text_field_tag :city, @address&.city,
                required: true,
                placeholder: "Toronto",
                style: "width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem;" %>
          </div>

          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">
              Postal Code <span style="color: #e74c3c;">*</span>
            </label>
            <%= text_field_tag :postal_code, @address&.postal_code,
                required: true,
                placeholder: "M5V 3A8",
                style: "width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem;" %>
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">
            Province/Territory <span style="color: #e74c3c;">*</span>
          </label>
          <%= select_tag :province_id,
              options_from_collection_for_select(@provinces, :id, :name, @address&.province_id),
              required: true,
              id: 'province_select',
              style: "width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem; background: white;",
              onchange: "updateTaxPreview()" %>
          <div style="margin-top: 0.5rem; padding: 0.75rem; background: #e8f5e9; border-left: 4px solid #27ae60; border-radius: 3px; font-size: 0.9rem;" id="tax_preview">
            <strong>Tax Information:</strong> Select a province to see applicable taxes
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div style="margin-top: 2rem;">
        <%= submit_tag "Place Order",
            style: "width: 100%; background: #27ae60; color: white; padding: 1rem; border: none; border-radius: 5px; font-size: 1.2rem; font-weight: bold; cursor: pointer;",
            onmouseover: "this.style.background='#229954'",
            onmouseout: "this.style.background='#27ae60'" %>

        <%= link_to "‚Üê Back to Cart", cart_path,
            style: "display: block; text-align: center; margin-top: 1rem; color: #7f8c8d; text-decoration: none; font-weight: bold;" %>
      </div>
    <% end %>
  </div>

  <!-- Order Summary -->
  <div style="background: white; border-radius: 10px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 20px;">
    <h2 style="font-size: 1.5rem; color: #2c3e50; margin-bottom: 1.5rem; border-bottom: 2px solid #ecf0f1; padding-bottom: 1rem;">
      üìã Order Summary
    </h2>

    <!-- Cart Items -->
    <div style="margin-bottom: 1.5rem;">
      <% @cart_items.each do |item| %>
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #ecf0f1;">
          <div style="flex: 1;">
            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 0.25rem;">
              <%= item[:product].name %>
            </div>
            <div style="color: #7f8c8d; font-size: 0.9rem;">
              Quantity: <%= item[:quantity] %> √ó ‚Ç¶<%= number_with_delimiter(item[:product].price.to_i) %>
            </div>
          </div>
          <div style="font-weight: bold; color: #1e3c72;">
            ‚Ç¶<%= number_with_delimiter(item[:line_total].to_i) %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Totals -->
    <div style="border-top: 2px solid #ecf0f1; padding-top: 1rem;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #7f8c8d;">
        <span>Subtotal:</span>
        <span id="subtotal">‚Ç¶<%= number_with_delimiter(@cart_total.to_i) %></span>
      </div>

      <div id="tax_breakdown" style="margin-bottom: 0.5rem; color: #7f8c8d; font-size: 0.9rem; display: none;">
        <!-- Will be populated by JavaScript -->
      </div>

      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #7f8c8d;">
        <span>Tax:</span>
        <span id="tax_amount">‚Ç¶0</span>
      </div>

      <div style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; color: #1e3c72; padding-top: 1rem; border-top: 2px solid #ecf0f1;">
        <span>Total:</span>
        <span id="total">‚Ç¶<%= number_with_delimiter(@cart_total.to_i) %></span>
      </div>
    </div>

    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 1rem; margin-top: 1.5rem; font-size: 0.85rem; color: #856404;">
      üí° <strong>Note:</strong> Tax will be calculated based on your selected province. Review your order carefully before placing it.
    </div>
  </div>
</div>

<!-- JavaScript for Tax Calculation Preview -->
<script>
  // Province tax data (Rubric 3.1.3)
  const provinces = {
    <% @provinces.each do |province| %>
      <%= province.id %>: {
        name: '<%= province.name %>',
        gst: <%= province.gst_rate || 0 %>,
        pst: <%= province.pst_rate || 0 %>,
        hst: <%= province.hst_rate || 0 %>,
        total: <%= province.total_tax_rate %>
      },
    <% end %>
  };

  const subtotal = <%= @cart_total %>;

  function updateTaxPreview() {
    const provinceId = document.getElementById('province_select').value;
    const province = provinces[provinceId];

    if (province) {
      let taxBreakdown = '';

      if (province.hst > 0) {
        taxBreakdown = `HST: ${(province.hst * 100).toFixed(2)}%`;
      } else {
        const parts = [];
        if (province.gst > 0) parts.push(`GST: ${(province.gst * 100).toFixed(2)}%`);
        if (province.pst > 0) parts.push(`PST: ${(province.pst * 100).toFixed(2)}%`);
        taxBreakdown = parts.join(' + ');
      }

      document.getElementById('tax_preview').innerHTML =
        `<strong>Tax Information for ${province.name}:</strong><br>${taxBreakdown} = ${(province.total * 100).toFixed(2)}% total`;

      // Update order summary
      const taxAmount = subtotal * province.total;
      const total = subtotal + taxAmount;

      document.getElementById('tax_amount').textContent =
        '‚Ç¶' + Math.round(taxAmount).toLocaleString();
      document.getElementById('total').textContent =
        '‚Ç¶' + Math.round(total).toLocaleString();

      // Show tax breakdown
      let breakdownHTML = '';
      if (province.gst > 0) {
        breakdownHTML += `<div style="display: flex; justify-content: space-between;"><span>GST (${(province.gst * 100).toFixed(2)}%):</span><span>‚Ç¶${Math.round(subtotal * province.gst).toLocaleString()}</span></div>`;
      }
      if (province.pst > 0) {
        breakdownHTML += `<div style="display: flex; justify-content: space-between;"><span>PST (${(province.pst * 100).toFixed(2)}%):</span><span>‚Ç¶${Math.round(subtotal * province.pst).toLocaleString()}</span></div>`;
      }
      if (province.hst > 0) {
        breakdownHTML += `<div style="display: flex; justify-content: space-between;"><span>HST (${(province.hst * 100).toFixed(2)}%):</span><span>‚Ç¶${Math.round(subtotal * province.hst).toLocaleString()}</span></div>`;
      }

      if (breakdownHTML) {
        document.getElementById('tax_breakdown').innerHTML = breakdownHTML;
        document.getElementById('tax_breakdown').style.display = 'block';
      }
    }
  }

  // Trigger on page load if a province is pre-selected
  document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('province_select').value) {
      updateTaxPreview();
    }
  });
</script>